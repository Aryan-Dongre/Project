{% extends "admin/base.html"%}
{% block page_title %}Payment{% endblock %}

{% block content %}

<h2 class="mb-4">Payment & Revenue Dashboard</h2>

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

<!--Revenue Card-->

<div class="row g-4">

    <div class="col-md-3">
        <div class="card revenue-card text-center p-4 shadow-sm">
            <h6>Total Revenue</h6>
            <h3>₹ {{ total_revenue }}</h3>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card revenue-card text-center p-4 shadow-sm">
            <h6>Today's Revenue</h6>
            <h3>₹ {{ today_revenue }}</h3>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card revenue-card text-center p-4 shadow-sm">
            <h6>This Month</h6>
            <h3>₹ {{ month_revenue }}</h3>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card revenue-card text-center p-4 shadow-sm">
            <h6>Total Transactions</h6>
            <h3>{{ total_transactions }}</h3>
        </div>
    </div>

</div>

<!--year Dropdown-->
<div class="row mt-5">
    <div class="col-md-3">
        <label class="form-label fw-bold">Select Year</label>
        <select id="yearSelect" class="form-select">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
        </select>
    </div>
</div>

<!--Monthly Revenue Chart-->
<div class="row mt-4">
    <div class="col-md-7 mb-4">
        <div class="card p-4 shadow-sm">
            <h5 class="mb-3">Monthly Revenue</h5>

            <div style="height: 350px;">
                <canvas id="monthlyChart"></canvas>
            </div>

        </div>
    </div>

    <!--Service Type Chart-->

    <div class="col-md-5 mb-4">
        <div class="card p-4 shadow-sm">
            <h5 class="mb-3">Revenue by Service Type</h5>

            <div style="height: 350px;">
                <canvas id="serviceChart"></canvas>
            </div>

        </div>
    </div>
</div>

<!--Status Part-->
<div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control w-25"
           placeholder="Search client...">

    <select id="statusFilter" class="form-select w-25">
        <option value="">All Status</option>
        <option value="SUCCESS">SUCCESS</option>
        <option value="FAILED">FAILED</option>
    </select>
</div>


<!--Transaction Part-->
<div class="row mt-5">
    <div class="col-12">
        <div class="card p-4 shadow-sm">
            <h5 class="mb-3">Client Transactions Details</h5>

             <div class="table-responsive">
                  <table class="table table-bordered table-hover" id="transactionTable">
                      <thead class="table-light">
                          <tr>
                             <th>Client Name</th>
                             <th>Date</th>
                             <th>Time</th>
                             <th>Amount (₹)</th>
                             <th>Payment</th>
                             <th>Appointment Status</th>
                          </tr>
                      </thead>
                      <tbody>
                      </tbody>
                  </table>
             </div>
        </div>
    </div>
</div>

<nav>
    <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>


{% endblock %}

{% block page_js %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let monthlyChart;
let serviceChart;
let currentPage = 1;

const rupeeFormatter = new Intl.NumberFormat('en-IN');


// ======================================
// LOAD ANALYTICS CHARTS
// ======================================
function loadAnalytics(year) {

    fetch(`/admin/payments/analytics-data?year=${year}`)
        .then(res => res.json())
        .then(data => {

            const months = [
                "Jan","Feb","Mar","Apr","May","Jun",
                "Jul","Aug","Sep","Oct","Nov","Dec"
            ];

            const monthlyRevenue = new Array(12).fill(0);

            for (const month in data.monthly) {
                const index = parseInt(month) - 1;
                monthlyRevenue[index] = data.monthly[month];
            }

            if (monthlyChart) monthlyChart.destroy();

            monthlyChart = new Chart(
                document.getElementById("monthlyChart"),
                {
                    type: "bar",
                    data: {
                        labels: months,
                        datasets: [{
                            label: "Revenue (₹)",
                            data: monthlyRevenue,
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart'
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: val =>
                                        '₹ ' + rupeeFormatter.format(val)
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx =>
                                        'Revenue: ₹ ' +
                                        rupeeFormatter.format(ctx.raw)
                                }
                            }
                        }
                    }
                }
            );

            const serviceLabels = Object.keys(data.service_type);
            const serviceValues = Object.values(data.service_type);

            if (serviceChart) serviceChart.destroy();

            serviceChart = new Chart(
                document.getElementById("serviceChart"),
                {
                    type: "pie",
                    data: {
                        labels: serviceLabels,
                        datasets: [{
                            data: serviceValues,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            duration: 1400,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx =>
                                        ctx.label + ': ₹ ' +
                                        rupeeFormatter.format(ctx.raw)
                                }
                            }
                        }
                    }
                }
            );

        })
        .catch(err => console.error("Analytics Load Error:", err));
}


// ======================================
// LOAD TRANSACTIONS TABLE
// ======================================
function loadTransactions(page = 1) {

    currentPage = page;

    const search = document.getElementById("searchInput")?.value || "";
    const status = document.getElementById("statusFilter")?.value || "";

    fetch(`/admin/payments/client-transactions?page=${page}&search=${search}&status=${status}`)
        .then(res => res.json())
        .then(result => {

            const tbody = document.querySelector("#transactionTable tbody");
            tbody.innerHTML = "";

            const rows = result.data;

            if (!rows || rows.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-3">
                            No records found
                        </td>
                    </tr>
                `;
                renderPagination(result.pages, result.page);
                return;
            }

            rows.forEach(row => {

                const paymentBadge =
                    row.payment_status === "SUCCESS"
                        ? `<span class="badge bg-success">SUCCESS</span>`
                        : `<span class="badge bg-danger">${row.payment_status}</span>`;

                const appointmentBadge =
                    row.appointment_status === "CONFIRMED"
                        ? `<span class="badge bg-primary">CONFIRMED</span>`
                        : `<span class="badge bg-warning text-dark">${row.appointment_status || '-'}</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${row.client_name || '-'}</td>
                        <td>${row.appointment_date}</td>
                        <td>${row.appointment_time}</td>
                        <td class="text-end">
                            ₹ ${rupeeFormatter.format(row.amount)}
                        </td>
                        <td class="text-center">${paymentBadge}</td>
                        <td class="text-center">${appointmentBadge}</td>
                    </tr>
                `;
            });

            renderPagination(result.pages, result.page);

        })
        .catch(err => console.error("Transaction Load Error:", err));
}


// ======================================
// RENDER PAGINATION
// ======================================
function renderPagination(totalPages, currentPage) {

    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    if (!totalPages || totalPages <= 1) return;

    // Previous Button
    pagination.innerHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#"
               onclick="loadTransactions(${currentPage - 1}); return false;">
               Previous
            </a>
        </li>
    `;

    let start = Math.max(1, currentPage - 2);
    let end = Math.min(totalPages, currentPage + 2);

    for (let i = start; i <= end; i++) {
        pagination.innerHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#"
                   onclick="loadTransactions(${i}); return false;">
                   ${i}
                </a>
            </li>
        `;
    }

    // Next Button
    pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#"
               onclick="loadTransactions(${currentPage + 1}); return false;">
               Next
            </a>
        </li>
    `;
}


// ======================================
// INITIAL PAGE LOAD
// ======================================
document.addEventListener("DOMContentLoaded", function () {

    const yearSelect = document.getElementById("yearSelect");

    loadAnalytics(yearSelect.value);
    loadTransactions();

    yearSelect.addEventListener("change", function () {
        loadAnalytics(this.value);
    });

    document.getElementById("searchInput")
        ?.addEventListener("keyup", () => loadTransactions(1));

    document.getElementById("statusFilter")
        ?.addEventListener("change", () => loadTransactions(1));

});
</script>




{% endblock %}