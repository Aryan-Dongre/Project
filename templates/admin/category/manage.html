{% extends "admin/base.html" %}

{% block page_title %}Manage Categories{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='admin/css/services.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}

<div class="service-page">

  <!-- ================= HEADER ================= -->
  <div class="services-header">
    <div class="header-text">
      <h2>
        <i class="fa-solid fa-folder-open me-2"></i>
        Categories
      </h2>
      <p>Manage service categories</p>
    </div>

    <a href="{{ url_for('admin.add_category') }}" class="btn btn-primary">
      <i class="fa-solid fa-plus me-1"></i>
      Add Category
    </a>
  </div>

  <!-- ================= TABLE ================= -->
  <div class="table-wrapper">
    <table class="services-table table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>
            <i class="fa-solid fa-tags me-1"></i>
            Category Name
          </th>
          <th>
            <i class="fa-solid fa-toggle-on me-1"></i>
            Status
          </th>
          <th class="text-right">
            <i class="fa-solid fa-gear me-1"></i>
            Actions
          </th>
        </tr>
      </thead>

      <tbody>
        {% if categories %}
          {% for c in categories %}
          <tr>
            <td>{{ loop.index }}</td>

            <td>
              <i class="fa-solid fa-folder text-muted me-2"></i>
              {{ c.name }}
            </td>

            <!-- STATUS TOGGLE -->
            <td class="text-center">
              <div class="form-check form-switch d-flex justify-content-center">
                <input
                  class="form-check-input category-status-toggle"
                  type="checkbox"
                  data-id="{{ c.id }}"
                  {% if c.status == 1 %}checked{% endif %}
                >
              </div>
            </td>

            <!-- ACTIONS -->
            <td class="actions text-right">
              <a href="{{ url_for('admin.edit_category', id=c.id) }}"
                 class="btn-edit"
                 title="Edit Category">
                <i class="fa-solid fa-pen-to-square"></i>
                  Edit
              </a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="no-data text-center">
              <i class="fa-solid fa-circle-info me-1"></i>
              No categories found
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>

<!-- ================= STATUS TOGGLE JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const toggleUrl = "{{ url_for('admin.toggle_category_status') }}";

  document.querySelectorAll(".category-status-toggle").forEach(toggle => {
    toggle.addEventListener("change", function () {

      const categoryId = this.dataset.id;
      const status = this.checked ? 1 : 0;

      fetch(toggleUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `category_id=${categoryId}&status=${status}`
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert("Status update failed");
          this.checked = !this.checked;
        }
      })
      .catch(() => {
        alert("Server error");
        this.checked = !this.checked;
      });

    });
  });

});
</script>

{% endblock %}
