{% extends "admin/base.html" %}

{% block page_title %}Manage Services{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='admin/css/services.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}

<!--Switch button -->
       <div class="page-actions">
         <a href="{{ url_for('admin.services_analytics')}}" class="btn btn-outline-primary">
            Service Analytics
         </a>
       </div>

<div class="service-page">

  <!-- ================= HEADER ================= -->
  <div class="services-header">
    <div class="header-text">
      <h2>Services</h2>
      <p>Manage all available services</p>
    </div>

    <a href="{{ url_for('admin.add_service') }}" class="btn btn-primary">
      + Add Service
    </a>
  </div>

  <!-- ================= FILTER BAR ================= -->
  <form method="get" class="services-filters">

    <!-- Search -->
    <input
      type="text"
      name="search"
      placeholder="Search service name"
      value="{{ request.args.get('search', '') }}"
    >

    <!-- Category -->
    <select name="category_id">
      <option value="">All Categories</option>
      {% for c in categories %}
        <option value="{{ c.id }}"
          {% if request.args.get('category_id') == c.id|string %}
            selected
          {% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>

    <!-- Service Type -->
    <select name="service_type_id">
      <option value="">All Types</option>
      {% for id, name in service_type_map.items() %}
        <option value="{{ id }}"
          {% if request.args.get('service_type_id') == id|string %}
            selected
          {% endif %}>
          {{ name }}
        </option>
      {% endfor %}
    </select>

    <!-- Status -->
    <select name="status">
      <option value="">All Status</option>
      <option value="1" {% if request.args.get('status') == '1' %}selected{% endif %}>
        Active
      </option>
      <option value="0" {% if request.args.get('status') == '0' %}selected{% endif %}>
        Inactive
      </option>
    </select>

    <!-- Buttons -->
    <button type="submit" class="btn btn-secondary">Filter</button>

    <a href="{{ url_for('admin.manage_services') }}" class="btn btn-secondary">
      Clear
    </a>

  </form>

  <!-- ================= TABLE ================= -->
  <div class="table-wrapper">
    <table class="services-table table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>Service Name</th>
          <th>Category</th>
          <th>Type</th>
          <th>Charges</th>
          <th>Duration</th>
          <th>Status</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% if services %}
          {% for s in services %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.category_name or "-" }}</td>
            <td>{{ service_type_map[s.service_type_id] }}</td>
            <td>â‚¹{{ s.charges }}</td>
            <td>{{ s.duration }} min</td>

            <!-- STATUS TOGGLE -->
            <td class="text-center">
              <div class="form-check form-switch d-flex justify-content-center">
                <input
                  class="form-check-input service-status-toggle"
                  type="checkbox"
                  data-id="{{ s.id }}"
                  {% if s.status == 1 %}checked{% endif %}
                >
              </div>
            </td>

            <!-- ACTIONS -->
            <td class="actions text-right">
              <a href="{{ url_for('admin.edit_service', id=s.id) }}" class="btn-edit">
                Edit
              </a>

              <form action="{{ url_for('admin.delete_service', id=s.id) }}"
                    method="POST"
                    style="display:inline;"
                    onsubmit="return confirm('Are you sure you want to delete this service?');">
                <button type="submit" class="btn-delete">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="no-data text-center">
              No services found
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>

<!-- ================= STATUS TOGGLE JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".service-status-toggle").forEach(toggle => {
    toggle.addEventListener("change", function () {

      const serviceId = this.dataset.id;
      const status = this.checked ? 1 : 0;

      fetch("/admin/services/toggle-status", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `service_id=${serviceId}&status=${status}`
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) {
          alert("Status update failed");
          this.checked = !this.checked;
        }
      })
      .catch(() => {
        alert("Server error");
        this.checked = !this.checked;
      });

    });
  });

});
</script>

{% endblock %}
